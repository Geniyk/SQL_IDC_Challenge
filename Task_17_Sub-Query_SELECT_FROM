
/* Daily Challenge:
Question: Question: Create a report showing each service with: service name, total patients admitted, 
the difference between their total admissions and the average admissions across all services, 
and a rank indicator ('Above Average', 'Average', 'Below Average'). Order by total patients admitted descending. */

Select s.service, s.total_admitted,
-- Difference from overall average
s.total_admitted - avg_table.avg_admitted AS Difference_from_average,
-- Rank Indicator
CASE
 WHEN s.total_admitted > avg_table.avg_admitted THEN 'Above Average'
  WHEN s.total_admitted = avg_table.avg_admitted THEN 'Average'
  ELSE 'Below Average'
  END AS rank_indicator
FROM ( -- Derived table
Select service, SUM(patients_admitted) as total_admitted
FROM services_weekly
GROUP BY service ) as s
-- JOIN WITH SUBQUERY THAT CALCULATE THE AVERAGE
JOIN ( Select AVG(total_admitted) as avg_admitted
FROM  (Select service, SUM(patients_admitted) as total_admitted
FROM services_weekly
GROUP BY service ) as j
) AS avg_table ON 1=1 -- cross join
ORDER BY s.total_admitted DESC;

-- OR

Select s.service, s.total_admitted,
    -- Difference from overall average
    s.total_admitted - overall.avg_admitted AS Difference_from_average,
-- Rank Indicator
CASE
 WHEN s.total_admitted > overall.avg_admitted THEN 'Above Average'
  WHEN s.total_admitted = overall.avg_admitted THEN 'Average'
  ELSE 'Below Average'
  END AS rank_indicator
FROM ( -- Derived table
Select service, SUM(patients_admitted) as total_admitted
FROM services_weekly
GROUP BY service ) as s
-- JOIN WITH SUBQUERY THAT CALCULATE THE AVERAGE
CROSS JOIN (
    SELECT AVG(total_admitted) AS avg_admitted
    FROM (
        SELECT service, SUM(patients_admitted) AS total_admitted
        FROM services_weekly
        GROUP BY service
    ) t
) AS overall
ORDER BY s.total_admitted DESC;
