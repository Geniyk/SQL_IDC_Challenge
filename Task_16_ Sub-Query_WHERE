/* Daily Challenge: **Question:** Find all patients who were admitted to services that had at least
one week where  patients were refused AND the average patient satisfaction for 
that service was below the overall hospital average satisfaction.  
Show patient_id, name, service, and their personal satisfaction score. */

Select p.patient_id, p.name, p.service, p.satisfaction
FROM patients p 
WHERE p.service IN ( Select sw.service 
From services_weekly sw
GROUP By sw.service
HAVING SUM(sw.patients_refused) > 0  AND
AVG(sw.patient_satisfaction) < ( Select
AVG(patient_satisfaction) FROM services_weekly) 
) ;

-- OR

Select p.patient_id, p.name, p.service, p.satisfaction
FROM patients p JOIN 
 ( Select service , 
AVG(patient_satisfaction) as avg_satisfaction
From services_weekly 
GROUP By service
HAVING SUM(patients_refused) > 0  AND
AVG(patient_satisfaction) < ( Select
AVG(patient_satisfaction) 
FROM services_weekly) ) as sw
ON p.service = sw.service; 
